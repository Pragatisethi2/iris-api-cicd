name: CML CI/CD Pipeline for Iris API

on:
  push:
    branches: [ main ]

jobs:
  cml-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: iterative/setup-cml@v1
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install matplotlib seaborn requests scikit-learn
    
    - name: Test model and generate report
      run: |
        python -c "
        import joblib
        import numpy as np
        from sklearn.datasets import load_iris
        from sklearn.metrics import accuracy_score
        import matplotlib.pyplot as plt
        import json
        
        # Load model and test
        model = joblib.load('model.joblib')
        iris = load_iris()
        X_test, y_test = iris.data, iris.target
        y_pred = model.predict(X_test)
        accuracy = accuracy_score(y_test, y_pred)
        
        # Create simple plot
        plt.figure(figsize=(8, 6))
        plt.bar(['Accuracy'], [accuracy])
        plt.ylim(0, 1)
        plt.title('Model Accuracy')
        plt.savefig('accuracy.png')
        
        # Save metrics
        with open('metrics.json', 'w') as f:
            json.dump({'accuracy': accuracy}, f)
        
        print(f'Model Accuracy: {accuracy:.4f}')
        "
    
    - name: Create CML Report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "# ðŸ¤– Iris Classifier CML Report" >> report.md
        echo "" >> report.md
        echo "## Model Performance" >> report.md
        ACCURACY=$(python -c "import json; print(json.load(open('metrics.json'))['accuracy'])")
        echo "**Accuracy:** $ACCURACY" >> report.md
        echo "" >> report.md
        echo "**API Status:** âœ… Deployed at http://104.198.237.109" >> report.md
        echo "" >> report.md
        cml publish accuracy.png --md >> report.md
        cml comment create report.md
