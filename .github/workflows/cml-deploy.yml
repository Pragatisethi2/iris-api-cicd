name: CML CI/CD Pipeline for Iris API

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: unique-alloy-459915-m1
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1-a
  IMAGE: iris-api

jobs:
  cml-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    - uses: iterative/setup-cml@v1
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install matplotlib seaborn requests scikit-learn
    
    - name: Test model and generate report
      run: |
        python -c "
        import joblib
        import numpy as np
        from sklearn.datasets import load_iris
        from sklearn.metrics import accuracy_score
        import matplotlib.pyplot as plt
        import json
        
        # Load model and test
        model = joblib.load('model.joblib')
        iris = load_iris()
        X_test, y_test = iris.data, iris.target
        y_pred = model.predict(X_test)
        accuracy = accuracy_score(y_test, y_pred)
        
        # Create simple plot
        plt.figure(figsize=(8, 6))
        plt.bar(['Accuracy'], [accuracy])
        plt.ylim(0, 1)
        plt.title('Model Accuracy')
        plt.savefig('accuracy.png')
        
        # Save metrics
        with open('metrics.json', 'w') as f:
            json.dump({'accuracy': accuracy}, f)
        
        print(f'Model Accuracy: {accuracy:.4f}')
        "
    
    - name: Create CML Report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "# ðŸ¤– Iris Classifier CML Report" >> report.md
        echo "" >> report.md
        echo "## Model Performance" >> report.md
        ACCURACY=$(python -c "import json; print(json.load(open('metrics.json'))['accuracy'])")
        echo "**Accuracy:** $ACCURACY" >> report.md
        echo "" >> report.md
        cml publish accuracy.png --md >> report.md
        cml comment create report.md

  deploy:
    runs-on: ubuntu-latest
    needs: cml-pipeline
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Configure Docker
      run: gcloud auth configure-docker us-central1-docker.pkg.dev
    
    - name: Build and Push
      run: |
        docker build -t $IMAGE:$GITHUB_SHA .
        docker tag $IMAGE:$GITHUB_SHA us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/$IMAGE:$GITHUB_SHA
        docker push us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/$IMAGE:$GITHUB_SHA
    
    - name: Deploy to Kubernetes
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE
        kubectl set image deployment/iris-api iris-api=us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/$IMAGE:$GITHUB_SHA
        kubectl rollout status deployment/iris-api
